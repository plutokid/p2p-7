!function(a,b){function o(b,c){var d=b.split("&");a.each(d,function(a){var b=a.split("=");b.length>1&&c(b[0],b[1])})}"undefined"!=typeof require&&(a=a||require("underscore"),b=b||require("backbone"));var c=/^\?(.*)/,d=/\((.*?)\)/g,e=/(\(\?)?:\w+/g,f=/\*\w+/g,g=/[\-{}\[\]+?.,\\\^$|#\s]/g,h=/(\?.*)$/,i=/^([^\?]*)/,j=/(\?)[\w-]+=/i,k=/[\:\*]([^\:\?\/]+)/g,l=/^[#\/]|\s+$/g,m=/\/$/;b.Router.arrayValueSplit="|";var n=function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=this.location.pathname;var c=this.root.replace(m,""),d=this.location.search;a.indexOf(c)||(a=a.substr(c.length)),d&&(a+=d)}else a=this.getHash();return a.replace(l,"")};a.extend(b.History.prototype,{getFragment:function(a){var c=this._wantsHashChange&&this._wantsPushState&&!this._hasPushState,d=n.apply(this,arguments);return null!=a||j.test(d)?c&&(d=d.replace(h,"")):d+=this.location.search,d},getQueryParameters:function(b){b=n.apply(this,arguments);var e=b.replace(i,""),f=e.match(c);if(f){e=f[1];var g={};return o(e,function(b,c){c=decodeURIComponent(c),g[b]?a.isString(g[b])?g[b]=[g[b],c]:g[b].push(c):g[b]=c}),g}return{}}}),a.extend(b.Router.prototype,{initialize:function(a){this.encodedSplatParts=a&&a.encodedSplatParts},getFragment:function(a,b,c){return a=n.apply(this,arguments),c&&(a=a.replace(h,"")),a},_routeToRegExp:function(b){var c=f.exec(b)||{index:-1},h=e.exec(b)||{index:-1},i=b.match(k)||[];b=b.replace(g,"\\$&").replace(d,"(?:$1)?").replace(e,function(a,b){return b?a:"([^\\/\\?]+)"}).replace(f,"([^?]*?)"),b+="([?]{1}.*)?";var j=new RegExp("^"+b+"$");return c.index>=0&&(j.splatMatch=h>=0?c.index-h.index:-1),j.paramNames=a.map(i,function(a){return a.substring(1)}),j.namedParameters=this.namedParameters,j},_extractParameters:function(d,e){var f=d.exec(e).slice(1),g={};f.length>0&&a.isUndefined(f[f.length-1])&&f.splice(f.length-1,1);var h=f.length&&f[f.length-1]&&f[f.length-1].match(c);if(h){var i=h[1],j={};if(i){var k=this;o(i,function(a,b){k._setParamValue(a,b,j)})}f[f.length-1]=j,a.extend(g,j)}var l=f.length;if(d.splatMatch&&this.encodedSplatParts){if(d.splatMatch<0)return f;l-=1}for(var m=0;l>m;m++)a.isString(f[m])&&(f[m]=decodeURIComponent(f[m]),d.paramNames&&d.paramNames.length>=m-1&&(g[d.paramNames[m]]=f[m]));return b.Router.namedParameters||d.namedParameters?[g]:f},_setParamValue:function(a,b,c){for(var d=a.split("."),e=c,f=0;f<d.length;f++){var g=d[f];f===d.length-1?e[g]=this._decodeParamValue(b,e[g]):e=e[g]=e[g]||{}}},_decodeParamValue:function(c,d){var e=b.Router.arrayValueSplit;if(e&&c.indexOf(e)>=0){for(var f=c.split(e),g=f.length-1;g>=0;g--)f[g]?f[g]=decodeURIComponent(f[g]):f.splice(g,1);return f}return c=decodeURIComponent(c),d?a.isArray(d)?(d.push(c),d):[d,c]:c},toFragment:function(b,c){return c&&(a.isString(c)||(c=this._toQueryString(c)),c&&(b+="?"+c)),b},_toQueryString:function(c,d){function f(a){return String(a).replace(e,encodeURIComponent(e))}var e=b.Router.arrayValueSplit;if(!c)return"";d=d||"";var g="";for(var h in c){var i=c[h];if(a.isString(i)||a.isNumber(i)||a.isBoolean(i)||a.isDate(i))i=this._toQueryParam(i),(a.isBoolean(i)||a.isNumber(i)||i)&&(g+=(g?"&":"")+this._toQueryParamName(h,d)+"="+f(encodeURIComponent(i)));else if(a.isArray(i)){for(var j="",k=0;k<i.length;k++){var l=this._toQueryParam(i[k]);(a.isBoolean(l)||l)&&(j+=e+f(l))}j&&(g+=(g?"&":"")+this._toQueryParamName(h,d)+"="+j)}else{var m=this._toQueryString(i,this._toQueryParamName(h,d,!0));m&&(g+=(g?"&":"")+m)}}return g},_toQueryParamName:function(a,b,c){return b+a+(c?".":"")},_toQueryParam:function(b){return a.isNull(b)||a.isUndefined(b)?null:b}})}("undefined"==typeof _?null:_,"undefined"==typeof Backbone?null:Backbone);